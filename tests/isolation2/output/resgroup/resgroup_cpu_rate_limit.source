-- start_ignore
DROP VIEW IF EXISTS busy;
DROP
DROP VIEW IF EXISTS cancel_all;
DROP
DROP TABLE IF EXISTS bigtable;
DROP
DROP ROLE IF EXISTS role1_cpu_test;
DROP
DROP ROLE IF EXISTS role2_cpu_test;
DROP
DROP RESOURCE GROUP rg1_cpu_test;
DROP
DROP RESOURCE GROUP rg2_cpu_test;
DROP
DROP LANGUAGE IF EXISTS plpythonu;
DROP
CREATE EXTENSION plcontainer;
CREATE
CREATE LANGUAGE plpythonu;
CREATE
-- end_ignore

-- plcontainer busy function.
CREATE OR REPLACE FUNCTION plbusy() RETURNS VOID AS $$ # container: plc_python_shared import md5 n=100000000000 p=2 m = md5.new() s = '1'*1000000 while p <= n: m.update(s) p=p+1 $$ LANGUAGE plcontainer;
CREATE

DROP TABLE IF EXISTS cpu_usage_samples;
DROP
CREATE TABLE cpu_usage_samples (sample text);
CREATE

-- fetch_sample: select cpu_usage from gp_toolkit.gp_resgroup_status
-- and dump them into text in json format then save them in db for
-- further analysis.
CREATE OR REPLACE FUNCTION fetch_sample() RETURNS text AS $$ import pygresql.pg as pg import json 
conn = pg.connect(dbname="isolation2resgrouptest") group_cpus = conn.query("select rsgname, cpu_usage from gp_toolkit.gp_resgroup_status")\ .getresult() json_text = json.dumps(dict([(name, json.loads(cpu)) for name, cpu in group_cpus])) sql = "insert into cpu_usage_samples values ('{value}')".format(value=json_text) conn.query(sql) return json_text $$ LANGUAGE plpythonu;
CREATE

-- verify_cpu_usage: calculate each QE's average cpu usage using all the data in
-- the table cpu_usage_sample. And compare the average value to the expected value.
-- return true if the practical value is close to the expected value.
CREATE OR REPLACE FUNCTION verify_cpu_usage(groupname TEXT, expect_cpu_usage INT, err_rate INT) RETURNS BOOL AS $$ import pygresql.pg as pg import json 
conn = pg.connect(dbname="isolation2resgrouptest") 
def add_vector(vec1, vec2): r = dict() for seg_id1, value1 in vec1.items(): r[seg_id1] = value1 + vec2[seg_id1] return r 

def verify_cpu_usage(): all_info = conn.query("select sample from cpu_usage_samples").getresult() usage_sum = reduce(add_vector, [json.loads(info)[groupname] for info, in all_info]) usage = [(float(v) / len(all_info)) for k, v in usage_sum.items() if k != "-1"] avg = sum(usage) / len(usage) return abs(avg - expect_cpu_usage) <= err_rate 
return verify_cpu_usage() $$ LANGUAGE plpythonu;
CREATE

CREATE TABLE bigtable AS SELECT i AS c1, 'abc' AS c2 FROM generate_series(1,50000) i;
CREATE 50000

CREATE VIEW busy AS SELECT count(*) FROM bigtable t1, bigtable t3 WHERE 0 = (t1.c1 % 2 + 10000)! AND 0 = (t3.c1 % 2 + 10000)! ;
CREATE

CREATE VIEW cancel_all AS SELECT pg_cancel_backend(procpid) FROM pg_stat_activity WHERE current_query LIKE 'SELECT * FROM busy%' or current_query LIKE 'SELECT plbusy%';
CREATE

ALTER RESOURCE GROUP admin_group SET cpu_rate_limit 1;
ALTER
-- ALTER RESOURCE GROUP admin_group SET cpu_rate_limit 30;
ALTER RESOURCE GROUP plgroup SET cpu_rate_limit 20;
ALTER

CREATE RESOURCE GROUP rg1_cpu_test WITH (concurrency=20, cpu_rate_limit=20, memory_limit=20);
CREATE
CREATE RESOURCE GROUP rg2_cpu_test WITH (concurrency=20, cpu_rate_limit=20, memory_limit=20);
CREATE
--
-- now we get prepared.
--
-- on empty load the cpu usage shall be 0%
--
-- create two roles and assign them to above groups
CREATE ROLE role1_cpu_test RESOURCE GROUP rg1_cpu_test;
CREATE
CREATE ROLE role2_cpu_test RESOURCE GROUP rg2_cpu_test;
CREATE
GRANT ALL ON busy TO role1_cpu_test;
GRANT
GRANT ALL ON plbusy TO role2_cpu_test;
ERROR:  relation "plbusy" does not exist

-- prepare parallel queries in the two groups
10: SET ROLE TO role1_cpu_test;
SET
11: SET ROLE TO role1_cpu_test;
SET
12: SET ROLE TO role2_cpu_test;
SET
13: SET ROLE TO role2_cpu_test;
SET
14: SET ROLE TO role2_cpu_test;
SET
15: SET ROLE TO role2_cpu_test;
SET
16: SET ROLE TO role2_cpu_test;
SET
17: SET ROLE TO role2_cpu_test;
SET
18: SET ROLE TO role2_cpu_test;
SET
19: SET ROLE TO role2_cpu_test;
SET

--
-- a group should burst to use all the cpu usage
-- when it's the only one with running queries.
--
-- however the overall cpu usage is controlled by a GUC
-- gp_resource_group_cpu_limit which is 90% by default.
--
-- so the cpu usage shall be 90%
--

10&: SELECT * FROM busy;  <waiting ...>
11&: SELECT * FROM busy;  <waiting ...>
12&: SELECT plbusy();  <waiting ...>
13&: SELECT plbusy();  <waiting ...>
14&: SELECT plbusy();  <waiting ...>
15&: SELECT plbusy();  <waiting ...>
16&: SELECT plbusy();  <waiting ...>
17&: SELECT plbusy();  <waiting ...>
18&: SELECT plbusy();  <waiting ...>
19&: SELECT plbusy();  <waiting ...>

-- start_ignore
TRUNCATE TABLE cpu_usage_samples;
TRUNCATE
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                           
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 60.78, "0": 58.71, "2": 60.83, "-1": 60.16}, "rg2_cpu_test": {"1": 0.1, "0": 0.1, "2": 0.04, "-1": 0.08}, "admin_group": {"1": 0.09, "0": 0.23, "2": 0.07, "-1": 0.35}, "plgroup": {"1": 28.69, "0": 27.8, "2": 28.75, "-1": 28.14}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 55.16, "0": 53.59, "2": 55.29, "-1": 53.32}, "rg2_cpu_test": {"1": 0.11, "0": 0.1, "2": 0.11, "-1": 0.09}, "admin_group": {"1": 0.11, "0": 0.06, "2": 0.07, "-1": 0.32}, "plgroup": {"1": 35.74, "0": 34.86, "2": 35.65, "-1": 34.78}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                           
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 46.94, "0": 46.91, "2": 47.1, "-1": 46.97}, "rg2_cpu_test": {"1": 0.07, "0": 0.08, "2": 0.08, "-1": 0.13}, "admin_group": {"1": 0.06, "0": 0.06, "2": 0.06, "-1": 0.31}, "plgroup": {"1": 43.04, "0": 43.0, "2": 42.55, "-1": 42.4}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 47.45, "0": 47.74, "2": 47.56, "-1": 46.74}, "rg2_cpu_test": {"1": 0.01, "0": 0.01, "2": 0.01, "-1": 0.03}, "admin_group": {"1": 0.19, "0": 0.07, "2": 0.07, "-1": 0.32}, "plgroup": {"1": 42.8, "0": 42.56, "2": 42.74, "-1": 41.71}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 45.57, "0": 45.6, "2": 45.64, "-1": 46.28}, "rg2_cpu_test": {"1": 0.05, "0": 0.05, "2": 0.01, "-1": 0.04}, "admin_group": {"1": 0.06, "0": 0.06, "2": 0.1, "-1": 0.32}, "plgroup": {"1": 44.15, "0": 44.17, "2": 44.39, "-1": 44.97}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
TRUNCATE TABLE cpu_usage_samples;
TRUNCATE
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                              
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 46.88, "0": 46.94, "2": 47.24, "-1": 46.25}, "rg2_cpu_test": {"1": 0.07, "0": 0.07, "2": 0.07, "-1": 0.06}, "admin_group": {"1": 0.07, "0": 0.17, "2": 0.06, "-1": 0.31}, "plgroup": {"1": 42.94, "0": 43.07, "2": 42.79, "-1": 42.82}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 51.01, "0": 51.4, "2": 50.99, "-1": 52.34}, "rg2_cpu_test": {"1": 0.01, "0": 0.04, "2": 0.01, "-1": 0.05}, "admin_group": {"1": 0.07, "0": 0.12, "2": 0.07, "-1": 0.32}, "plgroup": {"1": 38.99, "0": 38.54, "2": 38.98, "-1": 38.58}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 46.94, "0": 48.39, "2": 48.5, "-1": 47.25}, "rg2_cpu_test": {"1": 0.01, "0": 0.01, "2": 0.01, "-1": 0.01}, "admin_group": {"1": 0.06, "0": 0.17, "2": 0.11, "-1": 0.32}, "plgroup": {"1": 40.31, "0": 41.59, "2": 41.52, "-1": 41.62}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 45.17, "0": 45.29, "2": 44.69, "-1": 44.65}, "rg2_cpu_test": {"1": 0.05, "0": 0.05, "2": 0.05, "-1": 0.04}, "admin_group": {"1": 0.05, "0": 0.07, "2": 0.08, "-1": 0.3}, "plgroup": {"1": 45.03, "0": 45.11, "2": 45.43, "-1": 44.97}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
SELECT fetch_sample();
fetch_sample                                                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
{"rg1_cpu_test": {"1": 47.0, "0": 46.49, "2": 46.02, "-1": 46.08}, "rg2_cpu_test": {"1": 0.06, "0": 0.05, "2": 0.05, "-1": 0.05}, "admin_group": {"1": 0.11, "0": 0.07, "2": 0.07, "-1": 0.31}, "plgroup": {"1": 42.99, "0": 43.58, "2": 43.96, "-1": 42.88}, "default_group": {"1": 0.0, "0": 0.0, "2": 0.0, "-1": 0.0}}
(1 row)
SELECT pg_sleep(1.7);
pg_sleep
--------
        
(1 row)
-- end_ignore

SELECT verify_cpu_usage('plgroup', 40, 10);
verify_cpu_usage
----------------
t               
(1 row)

-- start_ignore
SELECT * FROM cancel_all;
pg_cancel_backend
-----------------
t                
t                
t                
t                
t                
t                
t                
t                
t                
t                
(10 rows)
10<:  <... completed>
ERROR:  canceling statement due to user request
11<:  <... completed>
ERROR:  canceling statement due to user request
12<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
13<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
14<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
15<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
16<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
17<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
18<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
19<:  <... completed>
ERROR:  plcontainer: Query and PL/Container connections are terminated by user request: Interrupted system call (comm_connectivity.c:76)
-- end_ignore

